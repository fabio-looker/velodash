<!DOCTYPE html>
<html>
<head>
<!--

	https://login.microsoftonline.com/d218a038-fce6-4d24-b555-da29bdb61480/oauth2/authorize?response_type=token&scope=openid&resource=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&client_id=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&redirect_uri=http%3A%2F%2Flocalhost%3A9090%2F&state=1234

	https://login.microsoftonline.com/d218a038-fce6-4d24-b555-da29bdb61480/.well-known/openid-configuration

-->
<script>var session = requireSession({
			idpAuthorizeUrl: (state)=>("https://login.microsoftonline.com/d218a038-fce6-4d24-b555-da29bdb61480/oauth2/authorize?response_type=token&scope=openid&resource=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&client_id=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&redirect_uri="+encodeURIComponent(location.origin+"/")+"&state="+encodeURIComponent(state))
		})
	function requireSession({idpAuthorizeUrl,reset, s=localStorage}){
			if(reset){clearSession()}
			var hash = getHashObj()
			if(isAuthenticating(hash)){
					if(isExpected(hash)){setSession(hash)}
					else{console.warn("Unexpected authorization attempt.")}
					location.hash = ''
				}
			if(hasSession()){return getSession()}
			location = idpAuthorizeUrl(setExpectation())
			return {}

			function isAuthenticating(hash){
					return !!hash.access_token
				}
			function setExpectation(){
					var arr = new Uint16Array(10);
					window.crypto.getRandomValues(arr);
					var str=''
					for (var i = 0; i < arr.length; i++) {str+=arr[i].toString(16)}
					s.setItem("oauthState",str)
					return str
				}
			function isExpected(hash){
					return hash.state == s.getItem("oauthState")
				}
			function setSession(hash) {
					s.setItem('access_token', hash.access_token)
					s.setItem('id_token', hash.id_token)
					s.setItem('expires_at', JSON.stringify(
							hash.expires_in * 1000 + new Date().getTime()
						))
				}
			function clearSession() {
					s.removeItem('access_token');
					s.removeItem('id_token');
					s.removeItem('expires_at');
				}
			function getSession() { return {
					accessToken:s.getItem('access_token'),
					idToken:s.getItem('id_token'),
					expiresAt:s.getItem('expires_at')
				}}
			function hasSession() {
					return new Date().getTime() < JSON.parse(s.getItem('expires_at'))
				}
		}
function getHashObj(){
		return (location.hash
				.slice(1)
				.split('&')
				.filter(Boolean)
				.map(ss=>ss.replace(/^\//,"route="))
				.map(ss=>ss.split('='))
				.reduce((aa,a)=>({[decodeURIComponent(a[0])]:decodeURIComponent(a.slice(1).join('=')), ...aa}),{})
			);
	}
</script>
</head>
<body style="color:#333;background-color:#eee">
	<div id="app"></div>
	<datalist id="strength-values">
	  <option value="0.0">
  	  <option value="0.5">
	  <option value="0.10">
  	  <option value="0.15">
	  <option value="0.20">
	  <option value="0.35">
	  <option value="0.50">
	  <option value="0.65">
	  <option value="0.80">
	  <option value="0.85">
	  <option value="0.90">
	  <option value="0.95">
	  <option value="0.99">
	</datalist>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hyperapp/1.2.5/hyperapp.js" integrity="sha256-EO1vRmcxDsotgvYvFuhhr9KbV3zX4a0uop87FBqNVwo=" crossorigin="anonymous"></script>
<script>
const {h,app} = hyperapp
const state = {
	route:"",
	flash:[],
	feedback:[{category:"adj-safe",strength:0.25},{category:"adj-safe",strength:0}],
	lookerReady:false,
	account:"foo"
}
const view = (s,a) =>
h("div",{},[
	h("ul",{id:"flash"},s.flash
			//.filter(flash=>flash.time>Date.now()-5)
			.map(flash=>h("li",{class:"st-"+flash.st},flash.msg))
		),
	h("div",{id:"breadcrumb"},[
		h("a",{href:"#/risk-overview"},"Risk Overview")
	]),
	{
		"risk-overview":
			h("div",{id:"route-risk-overview"},[
				h("a",{href:"#/risk-account&Account=123"},"Account A"),
				h("a",{href:"#/risk-account&Account=456"},"Account B")
				/*h("iframe",{
					id:"risk-overview-embed",
					class:"looker-embed",
					frameBorder:"0",
					src:"https://meta.looker.com/embed/dashboards/...?"+[
						"embed_domain="+document.location.origin
						//,"run=1",
						//,"Account=<id%20...>"
					].join("&")
				})*/
			]),
		"risk-account":
			h("div",{id:"risk-account"},[
				h("h3",{},"Account Risk-Safety Review"),
				h("div", {class:"feedback"}, s.feedback.map((feedback,f) =>
					h("div", {class:"row"},[
						h("div",{class:"category"},[
							h("label",{},"Type of Feedback"),
							h("select",feedbackInput(a,s,f,"category"),[
									option('adj-safe',"Adjust safer",feedback.category),
									option('adj-risk',"Adjust riskier",feedback.category),
									option('exp-safe',"Explain safety",feedback.category),
									option('exp-risk',"Explain risk",feedback.category)
								])
						]),
						h("div",{class:"strength"},[
							h("label",{},"Strength of Feedback"),
							h("input",{type:"range",min:"0",max:"0.99",list:"strength-values", ...feedbackInput(a,s,f,"strength")})
						]),
						h("div",{class:"subject"},[
							h("label",{},"Feedback Subject"),
							h("input",{type:"text", ...feedbackInput(a,s,f,"subject")})
						]),
						h("div",{class:"notes"},[
							h("label",{},"Notes"),
							h("textarea",feedbackInput(a,s,f,"notes"))
						]),
						h("div",{class:"wm12"},[
							feedback.category=='exp-risk'
							?	h("div",{class:"loeffort"},[
									h("label",{},"Level of effort"),
									h("input",{type:"number",min:"0",max:"99.9", ...feedbackInput(a,s,f,"loeffort")})
								])
							: feedback.category=='exp-safe'
							?	h("div",{class:"strength"},[
									h("label",{},"Monitor"),
									h("input",{type:"text", class:"wm12", ...feedbackInput(a,s,f,"monitor")})
								])
							: ""
						])
					])
				)),
				h("div", {},[
					h("iframe",{
						id:"risk-account-embed",
						class:"looker-embed",
						frameBorder:"0",
						src:"https://meta.looker.com/embed/dashboards/2676?"+[
							"embed_domain="+document.location.origin
							//,"run=1",
							//,"Account=<id%20...>"
						].join("&")
					})
				]),
				h("div", {class:"r"},[
					h("button",{},"Save")
				])
			])
	}[s.route || "risk-overview"]
	|| h("h3",{},"Invalid URL")
])
const actions = {
		none: value => state => state,
		//log: value => state => console.log(state),
		route: v => s => (
				s.lookerReady && v.Account != s.Account && setTimeout(run.pushFilters,0)
				,{
					route:v.route||s.route,
					account:v.Account||""
				}
			),
		feedback: input => state => (
				setTimeout(run.pushFilters,0)
				,{
					feedback:state.feedback.map((fb,f)=>
						f==input.dataset.feedbackNumber
						?{...fb, [input.dataset.feedbackAttribute]:input.value}
						:fb
					)
				}),
		lookerReady: v => s => (
				!s.lookerReady && setTimeout(run.pushFilters,0)
				,{lookerReady:true}
			),
		pushFilters: v => s => iframeFilterAndRun("risk-account-embed", s.feedback.reduce((accum,feedback,f)=>({
				...accum,
				["feedback_"+(1+f)+"_category"]:feedback.category,
				["feedback_"+(1+f)+"_strength"]:feedback.strength,
				["feedback_"+(1+f)+"_loeffort"]:feedback.loeffort
			}),{
				Account:" <id: "+s.account+">",
				loeffort_threshhold:8
			})),
		flash: v => s => (
				setTimeout(run.none,5000)
				,{flash:s.flash.slice(-10).concat(v)}
			)
	}

const run = app(state,actions,view,document.body)
run.route(getHashObj())

const ws = new WebSocket(
		`ws://${location.host}/?token=`
		+encodeURIComponent(session.accessToken)
	)
ws.onerror = () => console.error('WebSocket error')
ws.onopen = () => console.info('WebSocket connection established')
ws.onclose = () => console.info('WebSocket connection closed')

window.addEventListener("message",function(event){
		if(event.origin!=="https://meta.looker.com"){return;}
		var data = tryJsonParse(event.data)
		console.log("Top-window message received from "+event.origin,data||event)
		if(data.type=="dashboard:filters:changed"){run.lookerReady()}
	})
ws.addEventListener('message', function (event) {
		var data = tryJsonParse(event.data)
		if( data && data.msg){
				run.flash(data.msg)
				//$("#flash")
				//	.removeClass("st-warn st-ok st-err st-info st-undefined")
				//	.addClass("st-"+data.st)
				//	.txt(event.data.msg).show().delay(5000).fadeOut(3000)
			}
		console.log('WS:', event.data);
	})
window.addEventListener('hashchange',function(event){
		run.route(getHashObj())
	})

function feedbackInput(actions,state,number,attribute){return {
			"data-feedback-number":number,
			"data-feedback-attribute":attribute,
			value:state.feedback[number][attribute],
			onchange:evt=>actions.feedback(evt.target)
		}}


function option(val,label,selected){
		return h("option",{value:val,selected:selected==val||undefined},label)
	}
function iframeFilterAndRun(ifr,filter){
		console.info("Updating filters:",filter)
		document.getElementById(ifr).contentWindow.postMessage(JSON.stringify({
				"type": "dashboard:filters:update",
				"filters": filter
			}),"https://meta.looker.com")
		document.getElementById(ifr).contentWindow.postMessage(JSON.stringify({"type": "dashboard:run"}),"https://meta.looker.com")
	}





function getHashRoute(){
		return location.hash.split("&").filter(p=>p[0]=='/')[0]
	}
function wsapi(data){return ws.send(JSON.stringify(data))}

function tryJsonParse(s){try{return JSON.parse(s)}catch(e){return undefined}}

/*function api(endpoint,data){
		return $.ajax({
				url:"/"+endpoint,
				data: data,
				headers: {
						Authorization:"Bearer "+session.accessToken
					}
			})
	}*/

function handleHashState(){console.warn("TODO")}
</script>
<style type="text/css">
	.row {display: flex; flex-direction: row; justify-content: space-around;}
	label {display:block;font-size:0.6em;font-size:0.6em; color:#666;}
	.feedback>.row {background-color:#fff;border:1px solid #999;border-radius:0.25em;padding:0.25em 2em;margin:15px	0;box-shadow: 3px 3px 10px #999;}
	.feedback>.row>div
	.feedback input,.feedback select{height:2em;}
	.feedback textarea {height:3em;width:20em;}
	#flash {display:none;top:3em;width:24em;margin-left:auto;margin-right:auto;border-radius:0.25em;border-style:solid;border-radius:1px}
	.st-err {color:#633;background-color:#ecc;border-color:#633;}
	.st-warn {color:#553;background-color:#eec;border-color:#633;}
	.st-ok {color:#363;background-color:#cec;border-color:#633;}
	.st-info {color:#336;background-color:#cce;border-color:#633;}
	.st-undefined {color:#444;background-color:#ddd;border-color:#633;}
	.r {text-align:right;right:0}
	.looker-embed{height:36em;width:100%}
	.wm12 {width:12em;}
</style>
</html>
