<!DOCTYPE html>
<html>
<head>
<!--
	
	https://login.microsoftonline.com/d218a038-fce6-4d24-b555-da29bdb61480/oauth2/authorize?response_type=token&scope=openid&resource=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&client_id=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&redirect_uri=http%3A%2F%2Flocalhost%3A9090%2F&state=1234

	https://login.microsoftonline.com/d218a038-fce6-4d24-b555-da29bdb61480/.well-known/openid-configuration

-->
<style type="text/css">
	.row {display: flexbox;}
	#flash {display:none;top:3em;width:24em;margin-left:auto;margin-right:auto;border-radius:0.25em;border-style:solid;border-radius:1px}
	.st-err {color:#633;background-color:#ecc;border-color:#633;}
	.st-warn {color:#553;background-color:#eec;border-color:#633;}
	.st-ok {color:#363;background-color:#cec;border-color:#633;}
	.st-info {color:#336;background-color:#cce;border-color:#633;}
	.st-undefined {color:#444;background-color:#ddd;border-color:#633;}
</style>
<script>var session = requireSession({
			idpAuthorizeUrl: (state)=>("https://login.microsoftonline.com/d218a038-fce6-4d24-b555-da29bdb61480/oauth2/authorize?response_type=token&scope=openid&resource=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&client_id=94072ca3-e58d-4bfc-a0c8-63fddd45d15c&redirect_uri="+encodeURIComponent(location.origin+"/")+"&state="+encodeURIComponent(state))
		})
	function requireSession({idpAuthorizeUrl,reset, s=localStorage}){
			if(reset){clearSession()}
			var hash = urlToObj(window.location.hash)
			if(isAuthenticating(hash)){
					if(isExpected(hash)){setSession(hash)}
					else{console.warn("Unexpected authorization attempt.")}
					location.hash = ''
				}
			if(hasSession()){return getSession()}
			location = idpAuthorizeUrl(setExpectation())
			return {}
			
			function isAuthenticating(hash){
					return !!hash.access_token
				}
			function setExpectation(){
					var arr = new Uint16Array(10);
					window.crypto.getRandomValues(arr);
					var str=''
					for (var i = 0; i < arr.length; i++) {str+=arr[i].toString(16)}
					s.setItem("oauthState",str)
					return str
				}
			function isExpected(hash){
					return hash.state == s.getItem("oauthState")
				}
			function setSession(hash) {
					s.setItem('access_token', hash.access_token)
					s.setItem('id_token', hash.id_token)
					s.setItem('expires_at', JSON.stringify(
							hash.expires_in * 1000 + new Date().getTime()
						))
				}
			function clearSession() {
					s.removeItem('access_token');
					s.removeItem('id_token');
					s.removeItem('expires_at');
				}
			function getSession() { return {
					accessToken:s.getItem('access_token'),
					idToken:s.getItem('id_token'),
					expiresAt:s.getItem('expires_at')
				}}
			function hasSession() {
					return new Date().getTime() < JSON.parse(s.getItem('expires_at'))
				}
		}
function urlToObj(str){
		return (str.match(/[^?#].+/)||[''])[0].split('&').filter(Boolean).map(ss=>ss.split('='))
		.reduce((aa,a)=>({[decodeURIComponent(a[0])]:decodeURIComponent(a.slice(1).join('=')), ...aa}),{})
	}
</script>
</head>
<body>
	<div id="flash"></div>
	<h5>Dashboard</h5>
	<div><form id="editor">
		<table>
		<thead>
			<tr>
				<th>Outcome Type</th>
				<th>Feedback Type</th>
				<th>Feedback Strength</th>
				<!--<th>Challenge LoE</th>-->
				<th>Subject</th>
				<th>Notes</th>
				<th>&nbsp;</th>
			</tr>
		</thead>
		<tbody id="editor-body">
		</tbody>
		</table>
		<div>
			<input id="preview" type="button" value="Preview"></input>
			<input id="submit" type="button" value="Submit"></input>
		</div>
	</form></div>
	<div style="position:relative;top:0:left:0">
		<div id="btn-edit" style="position:absolute;top:1em;right:1em;display:inline-block;height:2em;width:12em;color:white;background-color:#639;border-radius:0.2em;text-align:center;padding-top:0.75em;">
			Explain
		</div>
		<iframe src="https://meta.looker.com/embed/dashboards/1" style="width:100%;height:24em"></iframe>
	</div>
	<datalist id="strength-values">
	  <option value="0">
  	  <option value="5">
	  <option value="10">
  	  <option value="15">
	  <option value="20">
	  <option value="35">
	  <option value="50">
	  <option value="65">
	  <option value="80">
	  <option value="85">
	  <option value="90">
	  <option value="95">
	  <option value="99">
	</datalist>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script>
var ws = new WebSocket(
		`ws://${location.host}/?token=`
		+encodeURIComponent(session.accessToken)
	)
ws.onerror = () => console.error('WebSocket error')
ws.onopen = () => console.info('WebSocket connection established')
ws.onclose = () => console.info('WebSocket connection closed')


$("#editor-body").append(row(1)+row(2)+row(3))
$("#editor-body").on("click","del",delRow)
$("#submit").click(()=>wsapi(JSON.stringify({
		a:0/*,
		$("#editor tr").map((i,el)=>({
				$("#")
			})).get()*/
	})))

ws.addEventListener('message', function (event) {
	var data = tryJsonParse(event.data)
	if( data && data.msg){
			$("#flash")
				.removeClass("st-warn st-ok st-err st-info st-undefined")
				.addClass("st-"+data.st)
				.txt(event.data.msg).show().delay(5000).fadeOut(3000)
		}
	console.log('WS:', event.data);
})

function wsapi(data){return ws.send(JSON.stringify(data))}

function tryJsonParse(s){try{return JSON.parse(s)}catch(e){return undefined}}

function api(endpoint,data){
		return $.ajax({
				url:"/"+endpoint,
				data: data,
				headers: {
						Authorization:"Bearer "+localStorage.getItem("access_token")
					}
			})
	}

		
function delRow(evt){
		return $(this.parentNode).remove()
	}
function row(number){
		return `<tr>
			<td>
				<select name="cat_${number}">
					<option val="adj-ren">The customer's likelihood to renew should be lower because of...</option>
					<option val="adj-non">The customer's likelihood to not-renew should be lower because of...</option>
					<option val="exp-ren">The customer's likelihood to renew would be explained by...</option>
					<option val="exp-non">The customer's likelihood to not-renew would be explained by...</option>
				<select>
			</td>
			<td>
				<input type="range" name="strength_${number}" list="strength-values" value="0"/>
			</td>
			<td>
				<input type="text" name="subject_${number}" />
			</td>
			<td>
				<textarea name="notes_${number}"></textarea>
			</td>
			<td> <span class="del">X</span> </td>
		</tr>`
	}
</script>
</html>
